<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Phase 2: Medical Compliance SQL Migration</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Inter', sans-serif; }
    .code-block {
      background: #1e293b;
      color: #e2e8f0;
      padding: 24px;
      border-radius: 12px;
      overflow-x: auto;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      line-height: 1.6;
      max-height: 600px;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-purple-50 to-pink-50 min-h-screen p-8">
  <div class="max-w-6xl mx-auto">
    <div class="bg-white rounded-2xl shadow-2xl p-10 mb-8">
      <h1 class="text-4xl font-bold text-gray-900 mb-4">ðŸ‡®ðŸ‡³ Phase 2: Medical Compliance SQL</h1>
      <p class="text-xl text-gray-600 mb-8">Prescription & GST Compliance Database Migration</p>

      <div class="bg-gradient-to-r from-purple-600 to-pink-600 text-white p-8 rounded-2xl mb-8">
        <h2 class="text-2xl font-bold mb-4">ðŸ“‹ What This Migration Adds:</h2>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <h3 class="font-bold mb-2">Prescription Compliance:</h3>
            <ul class="text-sm space-y-1">
              <li>âœ“ Schedule H/H1/X tracking</li>
              <li>âœ“ Prescription validity (30 days)</li>
              <li>âœ“ Digital signature fields</li>
              <li>âœ“ Narcotic drug logging</li>
              <li>âœ“ Prescription audit trail</li>
            </ul>
          </div>
          <div>
            <h3 class="font-bold mb-2">GST Compliance:</h3>
            <ul class="text-sm space-y-1">
              <li>âœ“ GSTIN on invoices</li>
              <li>âœ“ CGST/SGST/IGST calculation</li>
              <li>âœ“ HSN/SAC codes</li>
              <li>âœ“ GST returns tracking</li>
              <li>âœ“ Tax invoice format</li>
            </ul>
          </div>
        </div>
      </div>

      <div class="bg-orange-50 border-l-4 border-orange-500 p-6 rounded-xl mb-8">
        <h3 class="font-bold text-orange-900 mb-2">ðŸ“‹ Instructions:</h3>
        <ol class="list-decimal list-inside space-y-2 text-orange-800">
          <li>Click "Copy SQL" button below</li>
          <li>Go to Supabase Dashboard â†’ SQL Editor</li>
          <li>Click "New Query"</li>
          <li>Paste the SQL</li>
          <li>Click "Run"</li>
          <li>Wait for completion (~30 seconds)</li>
        </ol>
      </div>

      <div class="mb-8">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-2xl font-bold text-gray-900">Complete SQL Migration</h2>
          <button onclick="copySQL()" id="copyBtn" class="bg-gradient-to-r from-purple-500 to-pink-600 text-white px-8 py-4 rounded-xl font-bold text-lg hover:shadow-2xl transition transform hover:scale-105">
            ðŸ“‹ Copy SQL
          </button>
        </div>
        
        <div class="code-block" id="sqlCode">-- EdgesOf MediScript - Phase 2: Medical Compliance Migration
-- Prescription & GST Compliance for India

-- =====================================================
-- PRESCRIPTION COMPLIANCE FIELDS
-- =====================================================

ALTER TABLE prescriptions ADD COLUMN IF NOT EXISTS prescription_type VARCHAR(50) CHECK (prescription_type IN ('regular', 'narcotic', 'psychotropic'));
ALTER TABLE prescriptions ADD COLUMN IF NOT EXISTS validity_days INTEGER DEFAULT 30;
ALTER TABLE prescriptions ADD COLUMN IF NOT EXISTS expiry_date DATE;
ALTER TABLE prescriptions ADD COLUMN IF NOT EXISTS doctor_signature TEXT;
ALTER TABLE prescriptions ADD COLUMN IF NOT EXISTS digital_signature_hash TEXT;
ALTER TABLE prescriptions ADD COLUMN IF NOT EXISTS contains_schedule_h BOOLEAN DEFAULT false;
ALTER TABLE prescriptions ADD COLUMN IF NOT EXISTS contains_schedule_h1 BOOLEAN DEFAULT false;
ALTER TABLE prescriptions ADD COLUMN IF NOT EXISTS contains_schedule_x BOOLEAN DEFAULT false;
ALTER TABLE prescriptions ADD COLUMN IF NOT EXISTS is_valid BOOLEAN DEFAULT true;

-- =====================================================
-- MEDICINE SCHEDULE TRACKING
-- =====================================================

ALTER TABLE medicines ADD COLUMN IF NOT EXISTS schedule VARCHAR(10) CHECK (schedule IN ('OTC', 'H', 'H1', 'X', 'G'));
ALTER TABLE medicines ADD COLUMN IF NOT EXISTS mrp DECIMAL(10,2);
ALTER TABLE medicines ADD COLUMN IF NOT EXISTS hsn_code VARCHAR(20);
ALTER TABLE medicines ADD COLUMN IF NOT EXISTS max_daily_dose VARCHAR(100);
ALTER TABLE medicines ADD COLUMN IF NOT EXISTS contraindications TEXT[];
ALTER TABLE medicines ADD COLUMN IF NOT EXISTS drug_interactions_with TEXT[];
ALTER TABLE medicines ADD COLUMN IF NOT EXISTS requires_prescription BOOLEAN DEFAULT false;

-- =====================================================
-- GST COMPLIANCE FIELDS
-- =====================================================

ALTER TABLE invoices ADD COLUMN IF NOT EXISTS gstin VARCHAR(15);
ALTER TABLE invoices ADD COLUMN IF NOT EXISTS invoice_type VARCHAR(50) DEFAULT 'tax_invoice';
ALTER TABLE invoices ADD COLUMN IF NOT EXISTS place_of_supply VARCHAR(100);
ALTER TABLE invoices ADD COLUMN IF NOT EXISTS cgst_amount DECIMAL(10,2) DEFAULT 0;
ALTER TABLE invoices ADD COLUMN IF NOT EXISTS sgst_amount DECIMAL(10,2) DEFAULT 0;
ALTER TABLE invoices ADD COLUMN IF NOT EXISTS igst_amount DECIMAL(10,2) DEFAULT 0;
ALTER TABLE invoices ADD COLUMN IF NOT EXISTS gst_rate DECIMAL(5,2) DEFAULT 18.00;
ALTER TABLE invoices ADD COLUMN IF NOT EXISTS taxable_amount DECIMAL(10,2);
ALTER TABLE invoices ADD COLUMN IF NOT EXISTS round_off DECIMAL(10,2) DEFAULT 0;

ALTER TABLE invoice_items ADD COLUMN IF NOT EXISTS hsn_sac_code VARCHAR(20);
ALTER TABLE invoice_items ADD COLUMN IF NOT EXISTS gst_rate DECIMAL(5,2) DEFAULT 18.00;
ALTER TABLE invoice_items ADD COLUMN IF NOT EXISTS cgst_amount DECIMAL(10,2) DEFAULT 0;
ALTER TABLE invoice_items ADD COLUMN IF NOT EXISTS sgst_amount DECIMAL(10,2) DEFAULT 0;
ALTER TABLE invoice_items ADD COLUMN IF NOT EXISTS igst_amount DECIMAL(10,2) DEFAULT 0;
ALTER TABLE invoice_items ADD COLUMN IF NOT EXISTS taxable_amount DECIMAL(10,2);

-- =====================================================
-- DOCTOR COMPLIANCE FIELDS
-- =====================================================

ALTER TABLE users ADD COLUMN IF NOT EXISTS medical_council VARCHAR(100);
ALTER TABLE users ADD COLUMN IF NOT EXISTS registration_year INTEGER;
ALTER TABLE users ADD COLUMN IF NOT EXISTS registration_state VARCHAR(100);
ALTER TABLE users ADD COLUMN IF NOT EXISTS digital_signature_certificate TEXT;
ALTER TABLE users ADD COLUMN IF NOT EXISTS signature_image_url TEXT;
ALTER TABLE users ADD COLUMN IF NOT EXISTS can_prescribe_schedule_h BOOLEAN DEFAULT true;
ALTER TABLE users ADD COLUMN IF NOT EXISTS can_prescribe_schedule_h1 BOOLEAN DEFAULT false;
ALTER TABLE users ADD COLUMN IF NOT EXISTS can_prescribe_schedule_x BOOLEAN DEFAULT false;

-- =====================================================
-- CLINIC COMPLIANCE FIELDS
-- =====================================================

ALTER TABLE clinics ADD COLUMN IF NOT EXISTS clinical_establishment_registration VARCHAR(100);
ALTER TABLE clinics ADD COLUMN IF NOT EXISTS registration_authority VARCHAR(100);
ALTER TABLE clinics ADD COLUMN IF NOT EXISTS registration_date DATE;
ALTER TABLE clinics ADD COLUMN IF NOT EXISTS gstin VARCHAR(15);
ALTER TABLE clinics ADD COLUMN IF NOT EXISTS pan VARCHAR(10);
ALTER TABLE clinics ADD COLUMN IF NOT EXISTS state_code VARCHAR(2);
ALTER TABLE clinics ADD COLUMN IF NOT EXISTS place_of_business VARCHAR(100);

-- =====================================================
-- CONTROLLED SUBSTANCE LOG
-- =====================================================

CREATE TABLE IF NOT EXISTS controlled_substance_log (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    clinic_id UUID REFERENCES clinics(id) ON DELETE CASCADE,
    prescription_id UUID REFERENCES prescriptions(id) ON DELETE CASCADE,
    patient_id UUID REFERENCES patients(id) ON DELETE CASCADE,
    doctor_id UUID REFERENCES users(id) ON DELETE CASCADE,
    medicine_id UUID REFERENCES medicines(id),
    medicine_name VARCHAR(255) NOT NULL,
    schedule VARCHAR(10) NOT NULL,
    quantity INTEGER NOT NULL,
    dosage VARCHAR(100),
    indication TEXT,
    dispensed_date TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    pharmacist_name VARCHAR(255),
    pharmacist_license VARCHAR(100),
    patient_signature TEXT,
    pharmacist_signature TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- =====================================================
-- PRESCRIPTION AUDIT
-- =====================================================

CREATE TABLE IF NOT EXISTS prescription_audit (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    prescription_id UUID REFERENCES prescriptions(id) ON DELETE CASCADE,
    action VARCHAR(50) NOT NULL,
    performed_by UUID REFERENCES users(id),
    performed_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    details JSONB,
    ip_address VARCHAR(50),
    user_agent TEXT
);

-- =====================================================
-- GST RETURNS
-- =====================================================

CREATE TABLE IF NOT EXISTS gst_returns (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    clinic_id UUID REFERENCES clinics(id) ON DELETE CASCADE,
    return_period VARCHAR(20) NOT NULL,
    financial_year VARCHAR(10) NOT NULL,
    total_sales DECIMAL(12,2),
    total_cgst DECIMAL(12,2),
    total_sgst DECIMAL(12,2),
    total_igst DECIMAL(12,2),
    total_gst DECIMAL(12,2),
    status VARCHAR(50) DEFAULT 'draft' CHECK (status IN ('draft', 'filed', 'revised')),
    filed_date DATE,
    acknowledgement_number VARCHAR(100),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- =====================================================
-- DRUG INTERACTION WARNINGS
-- =====================================================

CREATE TABLE IF NOT EXISTS drug_interactions (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    medicine_a_id UUID REFERENCES medicines(id),
    medicine_b_id UUID REFERENCES medicines(id),
    interaction_type VARCHAR(50) CHECK (interaction_type IN ('major', 'moderate', 'minor')),
    description TEXT,
    recommendation TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- =====================================================
-- INDEXES FOR PERFORMANCE
-- =====================================================

CREATE INDEX IF NOT EXISTS idx_controlled_substance_log_clinic ON controlled_substance_log(clinic_id);
CREATE INDEX IF NOT EXISTS idx_controlled_substance_log_prescription ON controlled_substance_log(prescription_id);
CREATE INDEX IF NOT EXISTS idx_controlled_substance_log_schedule ON controlled_substance_log(schedule);
CREATE INDEX IF NOT EXISTS idx_prescription_audit_prescription ON prescription_audit(prescription_id);
CREATE INDEX IF NOT EXISTS idx_prescription_audit_performed_by ON prescription_audit(performed_by);
CREATE INDEX IF NOT EXISTS idx_gst_returns_clinic ON gst_returns(clinic_id);
CREATE INDEX IF NOT EXISTS idx_gst_returns_period ON gst_returns(return_period);
CREATE INDEX IF NOT EXISTS idx_medicines_schedule ON medicines(schedule);
CREATE INDEX IF NOT EXISTS idx_prescriptions_expiry ON prescriptions(expiry_date);

-- =====================================================
-- UPDATE EXISTING DATA
-- =====================================================

UPDATE clinics 
SET gstin = '27AABCU9603R1ZM',
    state_code = '27',
    place_of_business = 'Maharashtra',
    clinical_establishment_registration = 'MH/CER/2024/12345',
    registration_authority = 'Maharashtra Medical Council',
    registration_date = '2024-01-01'
WHERE name = 'City Health Clinic';

UPDATE users 
SET medical_council = 'Medical Council of India',
    registration_year = 2015,
    registration_state = 'Maharashtra',
    can_prescribe_schedule_h = true,
    can_prescribe_schedule_h1 = true,
    can_prescribe_schedule_x = false
WHERE email = 'doctor@clinic.com';

UPDATE medicines SET 
    schedule = 'OTC', 
    hsn_code = '30049099',
    requires_prescription = false,
    max_daily_dose = '4000mg'
WHERE name = 'Paracetamol';

UPDATE medicines SET 
    schedule = 'H', 
    hsn_code = '30042090',
    requires_prescription = true,
    max_daily_dose = '1500mg'
WHERE name = 'Amoxicillin';

UPDATE medicines SET 
    schedule = 'H', 
    hsn_code = '30042090',
    requires_prescription = true,
    max_daily_dose = '500mg'
WHERE name = 'Azithromycin';

UPDATE medicines SET 
    schedule = 'H', 
    hsn_code = '30049099',
    requires_prescription = true,
    max_daily_dose = '40mg'
WHERE name = 'Omeprazole';

UPDATE medicines SET 
    schedule = 'OTC', 
    hsn_code = '30049099',
    requires_prescription = false,
    max_daily_dose = '10mg'
WHERE name = 'Cetirizine';

UPDATE medicines SET 
    schedule = 'H', 
    hsn_code = '30049099',
    requires_prescription = true,
    max_daily_dose = '2000mg'
WHERE name = 'Metformin';

UPDATE medicines SET 
    schedule = 'H', 
    hsn_code = '30049099',
    requires_prescription = true,
    max_daily_dose = '10mg'
WHERE name = 'Amlodipine';

UPDATE medicines SET 
    schedule = 'H', 
    hsn_code = '30049099',
    requires_prescription = true,
    max_daily_dose = '80mg'
WHERE name = 'Atorvastatin';

INSERT INTO medicines (name, generic_name, brand_name, strength, unit, form, category, schedule, price, mrp, hsn_code, requires_prescription, max_daily_dose) VALUES
('Alprazolam', 'Alprazolam', 'Alprax', '0.5', 'mg', 'Tablet', 'Anxiolytic', 'H1', 25, 30, '30049099', true, '2mg'),
('Codeine', 'Codeine Phosphate', 'Codeine', '30', 'mg', 'Tablet', 'Opioid Analgesic', 'X', 50, 60, '30049099', true, '120mg')
ON CONFLICT DO NOTHING;

INSERT INTO drug_interactions (medicine_a_id, medicine_b_id, interaction_type, description, recommendation)
SELECT 
    m1.id,
    m2.id,
    'moderate',
    'Concurrent use may increase risk of bleeding',
    'Monitor patient closely for signs of bleeding'
FROM medicines m1, medicines m2
WHERE m1.name = 'Amoxicillin' AND m2.name = 'Atorvastatin'
ON CONFLICT DO NOTHING;

SELECT 'âœ… Phase 2 Medical Compliance migration completed successfully!' as status,
       'Prescription compliance, GST fields, and controlled substance tracking added' as details;</div>
      </div>

      <div class="bg-green-50 border-l-4 border-green-500 p-6 rounded-xl mt-8">
        <h3 class="font-bold text-green-900 mb-3">âœ… After Running This SQL:</h3>
        <ul class="space-y-2 text-green-800 text-sm">
          <li>âœ“ Prescription validity tracking (30 days default)</li>
          <li>âœ“ Schedule H/H1/X drug classification</li>
          <li>âœ“ Controlled substance logging</li>
          <li>âœ“ Digital signature fields</li>
          <li>âœ“ GST calculation (CGST/SGST/IGST)</li>
          <li>âœ“ HSN/SAC codes on invoices</li>
          <li>âœ“ Doctor registration validation</li>
          <li>âœ“ Clinic GSTIN tracking</li>
          <li>âœ“ Drug interaction warnings</li>
          <li>âœ“ Prescription audit trail</li>
        </ul>
      </div>

      <div class="mt-8 bg-gradient-to-r from-gray-900 to-gray-800 rounded-2xl p-10 text-white">
        <h3 class="text-2xl font-bold mb-6">ðŸŽ¯ Next: Update Application</h3>
        <p class="mb-4">After running this SQL, I'll update the application with:</p>
        <div class="grid grid-cols-2 gap-6">
          <div>
            <h4 class="font-bold mb-2">Prescription Features:</h4>
            <ul class="text-sm space-y-1">
              <li>â†’ Schedule H/H1/X warnings</li>
              <li>â†’ Prescription validity display</li>
              <li>â†’ Digital signature capture</li>
              <li>â†’ Controlled substance logging</li>
            </ul>
          </div>
          <div>
            <h4 class="font-bold mb-2">Billing Features:</h4>
            <ul class="text-sm space-y-1">
              <li>â†’ GST-compliant invoices</li>
              <li>â†’ CGST/SGST/IGST calculation</li>
              <li>â†’ HSN/SAC codes</li>
              <li>â†’ Tax invoice format</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    function copySQL() {
      const sqlCode = document.getElementById('sqlCode').textContent;
      navigator.clipboard.writeText(sqlCode).then(() => {
        const btn = document.getElementById('copyBtn');
        btn.innerHTML = 'âœ… Copied! Now paste in Supabase';
        btn.className = 'bg-gradient-to-r from-green-600 to-emerald-700 text-white px-8 py-4 rounded-xl font-bold text-lg shadow-2xl';
        
        setTimeout(() => {
          alert('âœ… SQL Copied!\n\nNext Steps:\n1. Go to Supabase Dashboard\n2. Click SQL Editor\n3. Click New Query\n4. Paste (Ctrl+V)\n5. Click Run\n6. Tell me "Done!"');
        }, 100);
      });
    }
  </script>
</body>
</html>